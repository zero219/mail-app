### å¾®æœåŠ¡

#### ç¯å¢ƒ

```pom
<java.version>1.8</java.version>
<spring-boot.version>2.4.2</spring-boot.version>
<spring-cloud-alibaba.version>2021.1</spring-cloud-alibaba.version>
<spring-cloud.version>2020.0.6</spring-cloud.version>
```

#### nacos

- ä¸‹è½½åœ°å€ `https://github.com/alibaba/nacos/releases?q=&expanded=true`
- å½“å‰é¡¹ç›®ä½¿ç”¨çš„æ˜¯`nacos-server-1.4.3`
- å¯åŠ¨nacos `startup.cmd -m standalone`

###### nacosæœåŠ¡æ³¨å†Œ

```pom
<!--æœ‰äº›springbooté¡¹ç›®åˆ›å»ºæ—¶æ²¡æœ‰å¼•å…¥ï¼Œå¼•å…¥å³å¯-->
<dependency>
    <groupId>org.springframework.boot</groupId>
       <artifactId>spring-boot-starter-web</artifactId>
</dependency>

<dependency>
   <groupId>com.alibaba.cloud</groupId>
   <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

å¯åŠ¨å…¥å£ä½¿ç”¨ `@EnableDiscoveryClient` å¼€å¯æœåŠ¡æ³¨å†Œå‘ç°åŠŸèƒ½

åˆ›å»º`application.properties`

```properties
æœåŠ¡ç«¯å£
server.port=9001
#æœåŠ¡åç§°
spring.application.name=mail-gateway
#nacosåœ°å€
spring.cloud.nacos.discovery.server-addr=127.0.0.1:8848
#å‘½åç©ºé—´
spring.cloud.nacos.discovery.namespace=14d70e72-71bc-45f4-a731-4fc19d3611f5
#åˆ†ç»„
spring.cloud.nacos.discovery.group=dev
```

###### nacosé…ç½®ä¸­å¿ƒ

``` java
<dependency>
     <groupId>com.alibaba.cloud</groupId>
     <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
<dependency>
     <groupId>org.springframework.cloud</groupId>
     <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
```

åˆ›å»º`bootstrap.yaml`æ–‡ä»¶

```yaml
spring:
  cloud:
    nacos:
      config:
        server-addr: 127.0.0.1:8848
        namespace: d7c3e4b3-1bc9-47a3-9a51-9adf6b71895b
        name: redis
        group: dev
        #refresh-enabled: true
        file-extension: yaml
        shared-configs:
          - data-id: redis
            group: dev
            refresh: true
```

æ§åˆ¶å™¨ä½¿ç”¨ `@RefreshScope` æ‰“å¼€åŠ¨æ€åˆ·æ–°åŠŸèƒ½

#### ç½‘å…³è®¾ç½®

 æ·»åŠ ä¾èµ–

```pom
<properties>
    <spring-cloud.version>2020.0.6</spring-cloud.version>
</properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-gateway</artifactId>
        </dependency>
    </dependencies>
    
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
```
`application.yml`æ·»åŠ é…ç½®

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: test_route
          uri: https://baidu.com
          predicates:
            - Query=url,baidu
          filters:
            - AddRequestParameter=foo, bar
```

è®¿é—®åœ°å€`localhost:9001?url=baidu`

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: admin_route
          uri: lb://renren-fast
          predicates:
            - Path=/api/** 
          filters:
            - RewritePath=/api/(?<segment>.*), /renren-fast/${segment}
```
###### ğŸ“‹ è·¯ç”±å­—æ®µè¯´æ˜

| å­—æ®µ         | è¯´æ˜                                                                                                                      |
|--------------|-------------------------------------------------------------------------------------------------------------------------|
| `id`         | è·¯ç”± IDï¼Œæ ‡è¯†è¿™æ¡è§„åˆ™ï¼Œèµ·ä¸ªåè€Œå·²                                                                                                      |
| `uri`        | è½¬å‘åœ°å€ï¼Œè¿™é‡Œæ˜¯ `lb://renren-fast`ï¼Œè¡¨ç¤ºä½¿ç”¨Nacosä¸­çš„æœåŠ¡åä¸º `renren-fast` çš„æœåŠ¡;<br/>å®ƒä¼šä» æ³¨å†Œä¸­å¿ƒï¼ˆå¦‚ Nacosã€Eurekaï¼‰è·å–æœåŠ¡å renren-fast å¯¹åº”çš„å¯ç”¨å®ä¾‹åŠç«¯å£ |
| `predicates` | åŒ¹é…è·¯å¾„çš„æ¡ä»¶ï¼šåªè¦è¯·æ±‚æ˜¯ä»¥ `/api/` å¼€å¤´çš„éƒ½ç¬¦åˆï¼ˆæ¯”å¦‚ `/api/user/list`ï¼‰                                                                      |
| `filters`    | å¯¹è¯·æ±‚åšè¿›ä¸€æ­¥å¤„ç†ï¼Œè¿™é‡Œç”¨äº† `RewritePath`ï¼Œå³é‡å†™è·¯å¾„                                                                                      |

---

###### ğŸ” RewritePath è·¯å¾„è½¬æ¢é€»è¾‘

| æ­¥éª¤       | å†…å®¹                                                                   |
|----------|------------------------------------------------------------------------|
| åŸå§‹è¯·æ±‚(å‰ç«¯) | `http://localhost:8080/api/user/list`                                                        |
| åŒ¹é…è§„åˆ™     | åŒ¹é… `/api/**`                                                         |
| è·¯å¾„æå–     | ä½¿ç”¨æ­£åˆ™ `(?<segment>.*)` æå– `/api/` åçš„éƒ¨åˆ†ï¼Œç»“æœæ˜¯ `user/list`   |
| é‡å†™è·¯å¾„     | `/renren-fast/${segment}` â‡’ `/renren-fast/user/list`                  |
| å®é™…åç«¯è¯·æ±‚è·¯å¾„ | `http://renren-fast/renren-fast/user/list`                             |

###### ç½‘å…³è§£å†³è·¨åŸŸé—®é¢˜

è¯¦ç»†ä»£ç åœ¨`CorsGlobalConfiguration.cs`ä¸­

#### openfeign

å®‰è£…ä¾èµ–

```pom
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
 </dependency>
```

å¯åŠ¨å…¥å£å¼€å¯opnefeign @EnableFeignClients

åˆ›å»ºopenfeignæ–‡ä»¶å¤¹ï¼Œæ·»åŠ æœåŠ¡

```java
// æœåŠ¡åç§°
@FeignClient("mail-gateway")
public interface GatewayFeignService {
    @GetMapping("/api/info")
    String info();
}
```

æœåŠ¡è°ƒç”¨

```java

@Autowired
GatewayFeignService gatewayFeignService;

@GetMapping("/info")
public String info() {
    gatewayFeignService.info();
}
```

